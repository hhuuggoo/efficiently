use_local_storage=false;storage={};storage.save=function(b,a){if(use_local_storage){localStorage.setItem(b,a)}};storage.S4=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)};storage.timestamp=function(){return new Date().getTime()};storage.guid=function(a){if(a){return a+"-"+storage.S4()+"-"+storage.timestamp()}else{return storage.S4()+"-"+storage.timestamp()}};storage.Collections=function(b,a){this.store_id=b;this.collections={};if(!a){a={}}this.types=a;this.server_queue={};this.saving=false};storage.Collections.prototype.new_id=function(){return storage.guid(this.store_id)};storage.Collections.prototype.storage_key=function(a,b){return JSON.stringify([this.store_id,a,b])};storage.Collections.prototype.parse_storage_key=function(c){try{var b=JSON.parse(c);if(b[0]==this.store_id){return[b[1],b[2]]}else{return null}}catch(a){console.log("unparseable "+c)}};storage.Collections.prototype.set_mem=function(a,b,c){if(!(c in this.collections)){this.collections[c]={}}this.collections[c][a]=b};storage.Collections.prototype.remove_mem=function(a,b){if(!(b in this.collections)){this.collections[b]={}}delete this.collections[b][a]};storage.Collections.prototype.save=function(a,b,d){var c;if(d in this.types){c=b.serialize()}else{c=JSON.stringify(b)}storage.save(this.storage_key(a,d),c);this.save_server(b.id,b,d);this.set_mem(a,b,d)};storage.Collections.prototype.remove=function(a,b){delete localStorage[this.storage_key(a,b)];this.remove_mem(a,b)};storage.Collections.prototype.get=function(a,b){if(!(b in this.collections)){return null}return this.collections[b][a]};storage.Collections.prototype.load_all=function(){if(!use_local_storage){return null}for(var d=0,a=localStorage.length;d<a;d++){var h=localStorage.key(d);var c;var e=this.parse_storage_key(h);var g;var f;if(!e){continue}c=e[0];g=e[1];f=localStorage[h];if(g in this.types){var b=new this.types[g]();b.deserialize(f);f=b}else{f=JSON.parse(f)}this.set_mem(c,f,g)}};storage.Collections.prototype.save_server_queue=function(){var c=this;if(_.all(c.server_queue,function(e,d){return $.isEmptyObject(e)})){c.saving=false;return null}c.saving=true;var b={};_.each(c.server_queue,function(d,e){b[e]={};_.each(d,function(g,f){b[e][f]=g;delete c.server_queue[e][f]})});var a=window.active_doc.get("saveurl");if(a==""){return null}else{if("id" in window.active_doc.socket_subscriber){b.clientid=window.active_doc.socket_subscriber.id}$.post(a,{data:JSON.stringify(b)},function(d){c.save_server_queue()}).error(function(d){alert("failure saving")})}};storage.Collections.prototype.save_server=function(b,a,d){var c=this;if(d in this.types){a=a.to_dict()}if(!(d in this.server_queue)){this.server_queue[d]={}}this.server_queue[d][b]=a;if(this.saving){return null}else{this.save_server_queue()}};var model={};model.Model=function(){this.dirty={}};model.Model.prototype.setter_name=function(a){return _.sprintf("_%s_setter",a)};model.Model.prototype.getter_name=function(a){return _.sprintf("_%s_getter",a)};model.Model.prototype.set=function(b,a){if(this.setter_name(b) in this){this[this.setter_name(b)](a)}else{this[b]=a}this.dirty[b]=true};model.Model.prototype.get=function(a){if(this.getter_name(a) in this){return this[this.getter_name(a)](a)}else{return this[a]}};model.Model.prototype.to_dict=function(){var a={};var b=this;_.each(this.fields,function(c){a[c]=b.get(c)});return a};model.Model.prototype.update=function(a){var b=this;_.each(this.fields,function(c){if(c in a){b.set(c,a[c])}})};model.Model.prototype.serialize=function(){return JSON.stringify(this.to_dict())};model.Model.prototype.deserialize=function(b){var a=JSON.parse(b);this.update(a)};model.Model.prototype.field_id=function(a){if(!a){return this.get("id")}else{return this.get("id")+"-"+a}};model.Model.prototype.field_el=function(a){if(!a){return this.el}else{return $("#"+this.field_id(a),this.el)}};model.Model.prototype.render_function=function(b){var a=this;if("render_"+b in this){return function(){a["render_"+b]()}}else{return function(){a.render_field(b)}}};model.Model.prototype.render_field=function(a){$("#"+this.field_id(a),this.el).html(this.get(a))};model.Model.prototype.render=function(a){if(!this.el){this.el=$(this.template(this.to_dict()));this.hook_events()}var b=this;_.each(this.fields,function(c){if(b.dirty[c]){b.render_function(c).call(b);delete b.dirty[c]}})};model.Model.prototype.template=function(){};model.Model.prototype.hook_events=function(){};function parentheses_words(c){c=_.strip(c);var e=0;var d=[];var b;var a=0;for(i=0;i<c.length;i++){if(c[i]=="("){if(!a){e=i}a+=1}if(a&&c[i]==")"){a-=1;if(a==0){b=c.slice(e,i+1);d.push(b);e=i+1}}if(!a&&c[i]==" "){d.push(c.slice(e,i+1));e=i+1}}d.push(c.slice(e,i+1));d=_.filter(d,function(f){return f!=" "&&f});d=_.map(d,function(f){return _.strip(f)});return d}function expression_graph(c){words=parentheses_words(c);var f=null;var e=null;var b=null;var a=0;var d;var g=function(h){if(!e){e=h;f=h}else{if("right" in e){console.log(["ERROR",c,d])}else{e.right=h;e=h}}};_.each(words,function(h){d=h;if(h=="and"||h=="or"){b={op:h,left:f};f=b;e=b}else{if(h=="not"){b={op:"not"};g(b)}else{if(_.startsWith(h,"(")){b=expression_graph(h.slice(1,h.length-1));g(b)}else{b={op:"match",arg:h};g(b)}}}});return f}function eval_match(b,a,c){if(c[b]){return true}if(a.indexOf(b)>=0){return true}return false}function eval_expression_graph(c,a,b){if(c.op=="and"){return eval_expression_graph(c.left,a,b)&&eval_expression_graph(c.right,a,b)}else{if(c.op=="or"){return eval_expression_graph(c.left,a,b)||eval_expression_graph(c.right,a,b)}else{if(c.op=="not"){return !eval_expression_graph(c.right,a,b)}else{return eval_match(c.arg,a,b)}}}}function get_tags(a,b){var c={};if(!a){return c}var d;_.each(b,function(e){d=a.match(e);d=_.map(d,function(f){return _.strip(f)});_.each(d,function(f){c[f]=true})});return c}var outline={};outline.Outline=function(b,a){this.set("id",b);this.set("documentid",a);this.set("text","");this.set("date",null);this.set("parent",null);this.set("children",[]);this.set("status","ACTIVE");this.set("chidden",false);this.dirty={};this.el=null;this.outline_state=0};outline.Outline.prototype=new model.Model();outline.Outline.prototype.fields=["documentid","username","id","text","date","children","parent","status","chidden"];outline.Outline.prototype.save=function(){window.collections.save(this.id,this,"outline")};outline.Outline.prototype.add_child=function(c,a){var b=this.get("children");if(a==null){b.push(c.id)}else{b.splice(a,0,c.id)}this.set("children",b);c.set("parent",this.id);c.set("status","ACTIVE");this.save();c.save()};outline.Outline.prototype.remove_child=function(b){b.set("parent",null);b.save();var a=this.get("children");a=_.filter(a,function(c){return c!=b.id});this.set("children",a);this.save()};outline.Outline.prototype.tree_apply=function(b,d){b(this);if(d>0||d==null){var c=(d==null)?null:d-1;var a=this.get("children");_.each(a,function(e){var f=window.collections.get(e,"outline");f.tree_apply(b,c)})}};outline.Outline.prototype.tree_apply_children_first=function(b,d){if(d>0||d==null){var c=(d==null)?null:d-1;var a=this.get("children");_.each(a,function(e){var f=window.collections.get(e,"outline");f.tree_apply(b,c)})}b(this)};outline.Outline.prototype.render_text=function(){if(this.field_el("textarea").css("display")!="none"){this.render_textarea()}else{this.render_textdisplay()}};outline.Outline.prototype.render_textdisplay=function(){this.field_el("textarea").hide();this.field_el("textdisplay").show();var a=this.field_el("textdisplay");var b=window.collections.get(this.get("documentid"),"document");a.html(b.color(this.get("text")));var c=_.words(this.get("text"))};outline.Outline.prototype.render_textarea=function(){var a=this.field_el("textarea");a.val(this.get("text"));var b=this;this.field_el("textarea").show();this.field_el("textdisplay").hide();window.setTimeout(function(){a.resizeNow.call(a)},100)};outline.Outline.prototype.render_children=function(){var a=this.get("children");var b=this;this.field_el("children").children().detach();if(a.length==0){b.field_el("childcontainer").hide()}else{b.field_el("childcontainer").show();_.each(a,function(d){var c=window.collections.get(d,"outline");c.render();b.field_el("children").append(c.el)})}};outline.Outline.prototype.render_hidden=function(){var b=this.visible_children();var a=this.get("children");if(a.length>b.length){this.field_el("hideindicator").html("+")}else{this.field_el("hideindicator").html("")}};outline.Outline.prototype.render=function(a){if(!this.el){if(!a){this.el=$(this.template(this.to_dict()));this.hook_events()}else{this.el=$(roottemplate(this.to_dict()));this.hook_events()}this.field_el("textarea").autoResize();this.field_el("childcontainer").hide()}var b=this;_.each(this.fields,function(c){if(b.dirty[c]){b.render_function(c).call(b);delete b.dirty[c]}})};outline.Outline.prototype.toggle_todo_state=function(){var a=collections.get(this.get("documentid"),"document");this.savetext();var b=a.transition_todo(this.get("text"));console.log(b);this.set("text",b);this.render();this.save()};outline.Outline.prototype.shade=function(){this.field_el("content").addClass("shade")};outline.Outline.prototype.unshade=function(){this.field_el("content").removeClass("shade")};outline.Outline.prototype._child_hidden_getter=function(){return this.field_el("childcontainer").css("display")=="none"};outline.Outline.prototype._hidden_getter=function(){return this.el.css("display")=="none"};outline.Outline.prototype.visible_children=function(){if(this.get("child_hidden")){return[]}else{var a=this.get("children");a=_.filter(a,function(b){return !window.collections.get(b,"outline").get("hidden")});return a}};outline.Outline.prototype.tree_search=function(b){this.show_all_descendants();var e=expression_graph(b);var c=[/(^|\s)@(\w+)/g,/(^|\s)#(\w+)/g];var a=false;c=c.concat(_.values(window.active_doc.state_regex_map));var d=function(f,h){_.extend(h,get_tags(f.get("text"),c));a=eval_expression_graph(e,f.get("text"),h);var g=_.map(f.get("children"),function(j){return d(window.collections.get(j,"outline"),_.clone(h))});if(!_.any(g)&&!a){f.el.hide();return false}else{f.render_hidden();return true}};d(this,{})};outline.Outline.prototype.render_chidden=function(){var a=this.get("chidden");if(a||this.get("children").length==0){this.field_el("childcontainer").hide()}else{this.field_el("childcontainer").show();_.each(this.get("children"),function(b){var c=window.collections.get(b,"outline");c.el.show()})}this.render_hidden()};outline.Outline.prototype.show_children=function(){this.set("chidden",false);this.render();this.save()};outline.Outline.prototype.hide_children=function(){this.set("chidden",true);this.render();this.save()};outline.Outline.prototype.show_all_descendants=function(){this.el.show();this.tree_apply(function(a){a.show_children()},null)};outline.Outline.prototype.show_all_children=function(){this.tree_apply(function(a){a.hide_children()},1);this.show_children()};outline.Outline.prototype.toggle_outline_state=function(){var a=this.outline_state;if(a<0||a>=2){a=0}else{a=a+1}this.outline_state=a;return this.outline_state};outline.Outline.prototype.show_outline_state=function(){if(this.outline_state==0){this.show_all_descendants()}else{if(this.outline_state==1){this.hide_children()}else{if(this.outline_state==2){this.show_all_children()}}}};outline.Outline.prototype.toggle_child_outline_state=function(){var a=this.toggle_outline_state();_.each(this.get("children"),function(b){var c=window.collections.get(b,"outline");c.outline_state=a});_.each(this.get("children"),function(b){var c=window.collections.get(b,"outline");c.show_outline_state()})};outline.Outline.prototype.template=_.template($("#outline-template").html());roottemplate=_.template($("#root-template").html());var deletenode=function(b){var a=function(d){var c=window.collections.get(d.parent,"outline");if(c){c.remove_child(d);c.render()}if(d.get("status")=="ACTIVE"){totrash(d)}else{todelete(d)}};b.tree_apply_children_first(a)};var totrash=function(a){a.set("status","TRASH");a.save();$("#trash").append(a.el)};var todelete=function(a){a.set("status","DELETE");a.save();a.el.remove();window.collections.remove(a.id,"outline")};var addsibling=function(d){var c=new outline.Outline(window.collections.new_id(),d.get("documentid"));var b=window.collections.get(d.parent,"outline");var a=_.indexOf(b.get("children"),d.get("id"));b.add_child(c,a+1);b.render();window.item_selector.select(c)};var add_new_child=function(c,a){var b=new outline.Outline(window.collections.new_id(),c.get("documentid"));c.add_child(b,a);c.render();window.item_selector.select(b)};outline.Outline.prototype.savetext=function(){if(!this.field_el("textarea").is(":visible")){return}var a=this.field_el("textarea").val();if(a!=this.get("text")){this.set("text",a);this.save()}};outline.Outline.prototype.hook_events=function(){var a=this;this.field_el("content").droppable({tolerance:"pointer",hoverClass:"ui-state-hover",drop:function(f,c){var d=c.draggable.data()["id"];var b=window.collections.get(d,"outline");var g=window.collections.get(b.parent,"outline");if(g){g.remove_child(b);g.render()}a.set("status","ACTIVE");a.add_child(b,0);a.render();c.draggable.css({top:0+"px",left:0+"px"})}});this.field_el("bottomedge").droppable({tolerance:"pointer",hoverClass:"ui-state-hover",drop:function(f,g){var c=window.collections.get(a.get("parent"),"outline");var j=c.get("children");var h=_.indexOf(j,a.id);var b=h+1;var l=g.draggable.data()["id"];var d=window.collections.get(l,"outline");var k=window.collections.get(d.parent,"outline");k.remove_child(d);c.add_child(d,b);k.render();c.render();g.draggable.css({top:0+"px",left:0+"px"})}});this.field_el("text").click(function(b){window.item_selector.select(a)});this.field_el("textarea").focus(function(b){window.item_selector._select(a)});this.field_el("textarea").blur(function(b){a.savetext();a.render_textdisplay()});this.field_el("textarea").keydown(function(c){if(c.keyCode==ENTER&&!window.modified(c)){a.field_el("textarea").blur();var b=a.field_el("textarea").val();if(!b&&a.get("children").length==0){}else{addsibling(a)}return false}else{if(c.keyCode==ENTER&&window.modified(c)){add_new_child(a,0);return false}else{if(c.keyCode==BACKSPACE&&!window.modified(c)){var b=a.field_el("textarea").val();if(!b&&a.get("children").length==0&&a.last_backspace_txt==b){a.field_el("textarea").blur();deletenode(a);return false}a.last_backspace_txt=b}}}});this.field_el("content").draggable({revert:"invalid",stack:"*",helper:function(){var b=$(a.field_el("content")).clone();$("textarea",b).val(a.get("text"));b.addClass("dragging");b.css({width:a.field_el("content").width()+"px"});return b}});this.field_el("content").data({id:this.id});this.field_el("fakedotcontainer").dblclick(function(b){toggle_controls(b,a)})};outline.Document=function(){this.set("title","");this.set("root_id",null);this.set("username",null);this.set("todostates",["TODO","INPROGRESS","DONE"]);this.set("todocolors",{TODO:"red",INPROGRESS:"red",DONE:"green"});this.set("status","ACTIVE")};outline.Document.prototype=new model.Model();outline.Document.prototype.fields=["id","title","root_id","username","todostates","todocolors","status"];outline.Document.prototype.save=function(){window.collections.save(this.id,this,"document")};outline.Document.prototype.make_state_regex_map=function(a){var c={};var b;if(!("state_regex_map" in this)){_.each(a,function(d){b=new RegExp(_.sprintf("(^%s)",d));c[d]=b});this.state_regex_map=c}};outline.Document.prototype._todostates_setter=function(a){var c=this;this.todostates=a;this.make_state_regex_map(a);var b={};_.each(a,function(e,d){if(d==a.length-1){b[e]=function(f){f=f.replace(c.state_regex_map[e],"");return f}}else{b[e]=function(f){f=f.replace(c.state_regex_map[e],a[d+1]);return f}}});b[""]=function(d){if(_.startsWith(d," ")){d=a[0]+d}else{d=a[0]+" "+d}return d};this.transition_function_map=b};outline.Document.prototype._todocolors_setter=function(c){var b=this;this.make_state_regex_map(_.keys(c));var a={};_.each(c,function(d,e){a[e]=function(f){r=b.state_regex_map[e];f=f.replace(r,_.sprintf("<span style='color:%s'>$1</span>",d));return f}});a[""]=function(d){return d};this.color_function_map=a;this.todocolors=c};outline.Document.prototype.parse_todostate=function(b){var a=this.get("todostates");var c=_.filter(a,function(d){return d&&_.startsWith(b,d)});if(c.length==0){c=""}else{c=c[0]}return c};outline.Document.prototype.transition_todo=function(a){var b=this.parse_todostate(a);a=this.transition_function_map[b](a);return a};outline.Document.prototype.color_todostate=function(a){var b=this.parse_todostate(a);a=this.color_function_map[b](a);return a};outline.Document.prototype.color=function(a){return this.color_todostate(outline.color_hashtags(outline.color_atpeople(a)))};window.active_obj=null;window.item_selector=null;window.controls=null;window.collections=null;window.active_doc=null;var toggle_controls=function(f,d){var c=d.field_el("fakedotcontainer");var a=function(l){window.item_selector.select(d);window.activeobj=d;window.controls.show();var s=l.pageX;var p=l.pageY;s=s-60;p=p-10;s=s<0?0:s;p=p<0?0:p;window.controls.css({top:p+"px",left:s+"px"});console.log({top:p+"px",left:s+"px"});var k=10;var g=c.offset().left;var u=g+c.width();var n=c.offset().top;var m=n+c.height();var j=window.controls.offset().left;var h=j+window.controls.width();var q=window.controls.offset().top;var o=q+window.controls.height();g=g-k;u=u+k;n=n-k;m=m+k;j=j-k;h=h+k;q=q-k;o=o+k;function t(v){if(!((v.pageX>=j&&v.pageX<=h&&v.pageY>=q&&v.pageY<=o)||(v.pageX>=g&&v.pageX<=u&&v.pageY>=n&&v.pageY<=m))){toggle_controls(v,d)}}$(document).bind("click",t)};var b=function(g){window.controls.hide();$(document).unbind("click");window.activeobj=null};if(window.activeobj!=d){a(f)}else{!window.controls.is(":visible")?a(f):b(f)}};var global_event_hooks=function(){$("#add-button").click(function(a){add_new_child(window.activeobj)});$("#state-button").click(function(a){window.activeobj.toggle_todo_state()});$("#overview-button").click(function(a){window.activeobj.toggle_outline_state();window.activeobj.show_outline_state()});$("#del-button").click(function(a){deletenode(window.activeobj);toggle_controls(a,window.activeobj);window.activeobj=null});$("#global-clear-trash").click(function(a){_.each(window.collections.collections.outline,function(b){if(b.get("status")=="TRASH"){deletenode(b)}})});$("#debugbtn").click(function(c){var b=get_matching_text("release")[0];b.render_text();var a=b.field_el("textarea")[0].scrollHeight;$("#debug").html(a)})};$(function(){var a=$("#document_id").html();var b=$("#root_id").html();var c=$("#mode").html();var d=$("#client_id").html();window.collections=new storage.Collections(d,{outline:outline.Outline,document:outline.Document});window.controls=$(".item-controls");window.controls.hide();window.activeobj=null;$.get("/document/"+a,function(j){var e=JSON.parse(j);var g=e.outline;var e=e.document;var h=new outline.Document();h.update(e);window.active_doc=h;if(c=="rw"){h.set("saveurl","/bulk/"+h.get("id"))}else{h.set("saveurl","")}window.collections.set_mem(h.id,h,"document");_.each(g,function(k){h=new outline.Outline();h.update(k);window.collections.set_mem(k.id,h,"outline")});var f=window.collections.get(window.active_doc.root_id,"outline");f.render(true);window.active_doc.field_el("outline").append(f.el);window.item_selector=new ItemSelector(f,window.collections);_.each(window.collections.collections.outline,function(k){if(k.get("status")=="TRASH"){k.render();$("#trash").append(k.el)}});window.active_doc.field_el("add").click(function(){var k=window.collections.get(window.active_doc.root_id,"outline");add_new_child(k)});window.active_doc.field_el("search").keypress(function(m){if(m.keyCode==ENTER){m.stopPropagation();var l=window.collections.get(window.active_doc.root_id,"outline");var k=window.active_doc.field_el("search").val();l.tree_search(k);m.preventDefault()}});global_event_hooks();window.register_sockets();if(f.get("children").length==0){add_new_child(f);f.render()}else{window.item_selector.cursor_down()}})});function get_matching_text(b){var a=[];_.each(window.collections.collections.outline,function(d,c){if(_.includes(d.get("text"),b)){a.push(d)}});return a}outline.color_hashtags=function(a){a=a.replace(/(^|\s)#(\w+)/g,"$1<span class='hashtag'>#$2</span>");return a};outline.color_atpeople=function(a){a=a.replace(/(^|\s)@(\w+)/g,"$1<span class='hashtag'>@$2</span>");return a};var UP=38;var DOWN=40;var LEFT=37;var RIGHT=39;var TAB=9;var GE=190;var LT=188;var SLASH=191;var S_KEY=83;var F_KEY=70;var R_KEY=82;var P_KEY=80;var L_BRACKET=219;var R_BRACKET=221;var FADEOUT_DELAY=4000;var ENTER=13;var BACKSPACE=8;var O_KEY=79;window.modified=function(a){return a.ctrlKey||a.shiftKey||a.altKey};window.nsmodified=function(a){return a.ctrlKey||a.altKey};ItemSelector=function(c,b){var d=this;this.collections=b;this.root_node=c;this.curr_node=null;this.curr_idx=0;this.get_keyfunction=function(h){var g=window.modified(h);var f=window.nsmodified(h);if(!g&&h.keyCode==UP){return this.keyfunctions.cursor_up}else{if(!g&&h.keyCode==DOWN){return this.keyfunctions.cursor_down}else{if(g&&h.keyCode==UP){return this.keyfunctions.move_up}else{if(g&&h.keyCode==DOWN){return this.keyfunctions.move_down}else{if(g&&h.keyCode==LEFT){return this.keyfunctions.move_left}else{if(g&&h.keyCode==RIGHT){return this.keyfunctions.move_right}else{if(g&&h.keyCode==BACKSPACE){return this.keyfunctions["delete"]}else{if(h.keyCode==GE&&f){return this.keyfunctions.toggle_outline}else{if(h.keyCode==SLASH&&f){return this.keyfunctions.toggle_all_outline}else{if(h.keyCode==LT&&f){return this.keyfunctions.toggle_todo}else{if(h.keyCode==P_KEY&&f){return this.keyfunctions.focus_isearch}else{if(h.keyCode==R_BRACKET&&f){return this.keyfunctions.isearch_down}else{if(h.keyCode==L_BRACKET&&f){return this.keyfunctions.isearch_up}else{if(h.keyCode==O_KEY&&f){return this.keyfunctions.focus_filter}else{return null}}}}}}}}}}}}}}};this.deletenode=function(){if(this.curr_node){var g=this.collections.get(this.curr_node.parent,"outline");var h=g.visible_children();var f=_.indexOf(h,this.curr_node.id);var e=null;if(f!=0){e=this.collections.get(h[f-1],"outline")}else{if(f<h.length-1){e=this.collections.get(h[f+1],"outline")}else{e=g}}deletenode(this.curr_node);this.select(e)}};this.cursor_up=function(){if(!this.curr_node){this.select(this.collections.get(this.root_node.visible_children()[0],"outline"))}else{var e=this.find_upper_node(this.curr_node);if(e){this.select(e)}}};this.cursor_down=function(){if(!this.curr_node){this.select(this.collections.get(this.root_node.visible_children()[0],"outline"))}else{var e=this.find_lower_visible_node(this.curr_node);if(e){this.unselect(this.curr_node);this.select(e)}}};this.lower_visible_sibling=function(f){var e=this.collections.get(f.parent,"outline");if(!e){return null}var h=e.visible_children();var g=_.indexOf(h,f.id);if(g<h.length-1){return this.collections.get(h[g+1],"outline")}else{return null}};this.upper_visible_sibling=function(f){var e=this.collections.get(f.parent,"outline");if(!e){return null}var h=e.visible_children();var g=_.indexOf(h,f.id);if(g!=0){return this.collections.get(h[g-1],"outline")}else{return null}};this.bottom_most_visible_descendant=function(g){var f;var e=g;while(true){f=e.visible_children();if(f.length==0){return e}else{e=this.collections.get(_.last(f),"outline")}}};this.find_upper_node=function(g){var f=this.collections.get(g.parent,"outline");var e=this.upper_visible_sibling(g);if(!e){if(f.id==this.root_node.id){return null}return f}else{return this.bottom_most_visible_descendant(e)}};this.find_lower_visible_node=function(g){children=g.visible_children();if(children.length>0){return this.collections.get(children[0],"outline")}var e=g;while(true){var f=this.lower_visible_sibling(e);if(!f&&e.id!=this.root_node.id){e=this.collections.get(e.parent,"outline")}else{if(!f&&e.id==this.root_node.id){return null}else{if(f){return f}}}}};this.move_right=function(){var f=this.curr_node;var e=this.collections.get(f.parent,"outline");var h=e.visible_children();children=f.visible_children();var g=_.indexOf(h,f.id);if(g==0){return null}else{upper_sibling=this.collections.get(h[g-1],"outline");e.remove_child(f);upper_sibling.add_child(f);e.render();upper_sibling.render()}d.select(f)};this.move_left=function(){var g=this.curr_node;var f=this.collections.get(g.parent,"outline");var h=this.collections.get(f.parent,"outline");if(!h||!f){return null}var e=_.indexOf(h.visible_children(),f.id)+1;f.remove_child(g);h.add_child(g,e);f.render();h.render();d.select(g)};this.move_up=function(){var g=this.curr_node;var f=this.collections.get(g.parent,"outline");var h=f.visible_children();var e=_.indexOf(h,g.id);if(e==0){return null}else{f.remove_child(g);f.add_child(g,e-1)}f.render();g.shade();d.select(g)};this.move_down=function(){var g=this.curr_node;var f=this.collections.get(g.parent,"outline");var h=f.visible_children();var e=_.indexOf(h,g.id);if(e>=h.length-1){return null}else{f.remove_child(g);f.add_child(g,e+1)}f.render();g.shade();d.select(g)};this.search_fade_out=function(){var e=storage.timestamp();if(e-this.search_active_timestamp>=FADEOUT_DELAY){console.log("fading out");$("#searchbox").fadeOut(300)}};this.search_fade_in=function(){if(!$("#searchbox").is(":visible")){$("#searchbox").fadeIn(300);this.search_active_timestamp=storage.timestamp();window.setTimeout(function(){d.search_fade_out.call(d)},FADEOUT_DELAY)}};this.isearch_strings=function(e,f){if(e.toLowerCase()==e){return[e.toLowerCase(),f.toLowerCase()]}else{return[e,f]}};this.isearch_down=function(){if(!this.curr_node){this.cursor_down()}this.search_fade_in();var h;var m=$("#searchtext").val();var f=this.curr_node.field_el("textarea")[0].selectionEnd;var k;var g;var j=function(o,n){g=d.isearch_strings(m,o.get("text"));m=g[0];curr_txt=g[1];console.log(["searching",m,curr_txt]);h=curr_txt.indexOf(m,n);if(h>=0){d.select(o);o.field_el("textarea")[0].setSelectionRange(h,h+m.length);return true}else{return false}};var l=j(this.curr_node,f);if(!l){var e=this.curr_node;while(true){e=this.find_lower_visible_node(e);if(!e){break}else{l=j(e,0);if(l){break}}}}};this.isearch_down.noselect=true;this.isearch_up=function(){if(!this.curr_node){this.cursor_down()}this.search_fade_in();var h;var m=$("#searchtext").val();var f=this.curr_node.field_el("textarea")[0].selectionStart-1;var k;var g;var j=function(o,n){if(n<0){return false}g=d.isearch_strings(m,o.get("text"));m=g[0];curr_txt=g[1];console.log(["searching",m,curr_txt]);h=curr_txt.lastIndexOf(m,n);if(h>=0){d.select(o);o.field_el("textarea")[0].setSelectionRange(h,h+m.length);return true}else{return false}};var l=j(this.curr_node,f);if(!l){var e=this.curr_node;while(true){e=this.find_upper_node(e);console.log(["searching",e.get("text")]);if(!e){break}else{l=j(e,e.get("text").length);if(l){break}}}}};this.isearch_up.noselect=true;this.focus_isearch=function(){$("#searchbox").fadeIn(300);console.log("focus isearch");$("#searchtext").focus()};this.focus_isearch.noselect=true;$("#searchtext").blur(function(){$("#searchbox").fadeOut(300)});this.keyfunctions={cursor_up:this.cursor_up,cursor_down:this.cursor_down,move_up:this.move_up,move_down:this.move_down,move_left:this.move_left,move_right:this.move_right,"delete":this.deletenode,toggle_outline:function(){if(this.curr_node){this.curr_node.toggle_outline_state();this.curr_node.show_outline_state()}},toggle_all_outline:function(){if(this.curr_node){this.root_node.toggle_child_outline_state()}},toggle_todo:function(){if(this.curr_node){this.curr_node.toggle_todo_state()}},isearch_up:this.isearch_up,isearch_down:this.isearch_down,focus_isearch:this.focus_isearch,focus_filter:function(){window.active_doc.field_el("search").focus()}};$("#searchbox").hide();var a=function(){if(d.curr_node){d.curr_node.savetext()}window.setTimeout(function(){a()},1000)};a();this._select=function(e){if(e){this._unselect(this.curr_node);this.curr_node=e;e.shade();e.render_textarea()}};this._unselect=function(e){if(e){e.savetext();e.unshade();e.render_textdisplay()}};this.select=function(e){if(e){e.field_el("textarea").focus()}};this.unselect=function(e){if(e){e.field_el("textarea").blur()}};$(document).keydown(function(g){var f=d.get_keyfunction(g);if(f){f.call(d);return false}else{return true}});$(document).keyup(function(g){var f=d.get_keyfunction(g);if(f){return false}else{return true}});$("#left-button-ctrl").click(function(){d.move_left()});$("#right-button-ctrl").click(function(){d.move_right()});$("#up-button-ctrl").click(function(){d.move_up()});$("#down-button-ctrl").click(function(){d.move_down()});$("#hide-button-ctrl").click(function(){d.keyfunctions.toggle_outline.call(d)});$("#todo-button-ctrl").click(function(){d.keyfunctions.toggle_todo.call(d)});$("#add-button-ctrl").click(function(){if(d.curr_node&&d.curr_node.get("status")=="ACTIVE"){addsibling(d.curr_node)}else{add_new_child(d.root_node)}});$("#del-button-ctrl").click(function(){if(d.curr_node){deletenode(d.curr_node)}})};$(function(){$(document).scroll(function(){$("#control").css({top:window.pageYOffset,left:window.pageXOffset});$("#control").show();console.log("scroll!")})});this.io={version:"0.6.2",setPath:function(a){if(window.console&&console.error){console.error("io.setPath will be removed. Please set the variable WEB_SOCKET_SWF_LOCATION pointing to WebSocketMain.swf")}this.path=/\/$/.test(a)?a:a+"/";WEB_SOCKET_SWF_LOCATION=a+"lib/vendor/web-socket-js/WebSocketMain.swf"}};if("jQuery" in this){jQuery.io=this.io}if(typeof window!="undefined"){if(typeof WEB_SOCKET_SWF_LOCATION==="undefined"){WEB_SOCKET_SWF_LOCATION="/socket.io/lib/vendor/web-socket-js/WebSocketMain.swf"}}(function(){var a=false;io.util={ios:false,load:function(b){if(/loaded|complete/.test(document.readyState)||a){return b()}if("attachEvent" in window){window.attachEvent("onload",b)}else{window.addEventListener("load",b,false)}},inherit:function(d,b){for(var c in b.prototype){d.prototype[c]=b.prototype[c]}},indexOf:function(b,e,f){for(var c=b.length,d=(f<0)?Math.max(0,c+f):f||0;d<c;d++){if(b[d]===e){return d}}return -1},isArray:function(b){return Object.prototype.toString.call(b)==="[object Array]"},merge:function(d,b){for(var c in b){if(b.hasOwnProperty(c)){d[c]=b[c]}}}};io.util.ios=/iphone|ipad/i.test(navigator.userAgent);io.util.android=/android/i.test(navigator.userAgent);io.util.opera=/opera/i.test(navigator.userAgent);io.util.load(function(){a=true})})();(function(){var a="~m~",b=function(c){if(Object.prototype.toString.call(c)=="[object Object]"){if(!("JSON" in window)){if("console" in window&&console.error){console.error("Trying to encode as JSON, but JSON.stringify is missing.")}return'{ "$error": "Invalid message" }'}return"~j~"+JSON.stringify(c)}else{return String(c)}};Transport=io.Transport=function(d,c){this.base=d;this.options={timeout:15000};io.util.merge(this.options,c)};Transport.prototype.send=function(){throw new Error("Missing send() implementation")};Transport.prototype.connect=function(){throw new Error("Missing connect() implementation")};Transport.prototype.disconnect=function(){throw new Error("Missing disconnect() implementation")};Transport.prototype._encode=function(g){var d="",f,g=io.util.isArray(g)?g:[g];for(var e=0,c=g.length;e<c;e++){f=g[e]===null||g[e]===undefined?"":b(g[e]);d+=a+f.length+a+f}return d};Transport.prototype._decode=function(g){var f=[],e,h;do{if(g.substr(0,3)!==a){return f}g=g.substr(3);e="",h="";for(var d=0,c=g.length;d<c;d++){h=Number(g.substr(d,1));if(g.substr(d,1)==h){e+=h}else{g=g.substr(e.length+a.length);e=Number(e);break}}f.push(g.substr(0,e));g=g.substr(e)}while(g!=="");return f};Transport.prototype._onData=function(f){this._setTimeout();var e=this._decode(f);if(e&&e.length){for(var d=0,c=e.length;d<c;d++){this._onMessage(e[d])}}};Transport.prototype._setTimeout=function(){var c=this;if(this._timeout){clearTimeout(this._timeout)}this._timeout=setTimeout(function(){c._onTimeout()},this.options.timeout)};Transport.prototype._onTimeout=function(){this._onDisconnect()};Transport.prototype._onMessage=function(c){if(!this.sessionid){this.sessionid=c;this._onConnect()}else{if(c.substr(0,3)=="~h~"){this._onHeartbeat(c.substr(3))}else{if(c.substr(0,3)=="~j~"){this.base._onMessage(JSON.parse(c.substr(3)))}else{this.base._onMessage(c)}}}},Transport.prototype._onHeartbeat=function(c){this.send("~h~"+c)};Transport.prototype._onConnect=function(){this.connected=true;this.connecting=false;this.base._onConnect();this._setTimeout()};Transport.prototype._onDisconnect=function(){this.connecting=false;this.connected=false;this.sessionid=null;this.base._onDisconnect()};Transport.prototype._prepareUrl=function(){return(this.base.options.secure?"https":"http")+"://"+this.base.host+":"+this.base.options.port+"/"+this.base.options.resource+"/"+this.type+(this.sessionid?("/"+this.sessionid):"/")}})();(function(){var d=new Function,a=(function(){if(!("XMLHttpRequest" in window)){return false}var e=new XMLHttpRequest();return e.withCredentials!=undefined})(),c=function(h){if("XDomainRequest" in window&&h){return new XDomainRequest()}if("XMLHttpRequest" in window&&(!h||a)){return new XMLHttpRequest()}if(!h){try{var g=new ActiveXObject("MSXML2.XMLHTTP");return g}catch(j){}try{var f=new ActiveXObject("Microsoft.XMLHTTP");return f}catch(j){}}return false},b=io.Transport.XHR=function(){io.Transport.apply(this,arguments);this._sendBuffer=[]};io.util.inherit(b,io.Transport);b.prototype.connect=function(){this._get();return this};b.prototype._checkSend=function(){if(!this._posting&&this._sendBuffer.length){var e=this._encode(this._sendBuffer);this._sendBuffer=[];this._send(e)}};b.prototype.send=function(e){if(io.util.isArray(e)){this._sendBuffer.push.apply(this._sendBuffer,e)}else{this._sendBuffer.push(e)}this._checkSend();return this};b.prototype._send=function(f){var e=this;this._posting=true;this._sendXhr=this._request("send","POST");this._sendXhr.onreadystatechange=function(){var g;if(e._sendXhr.readyState==4){e._sendXhr.onreadystatechange=d;try{g=e._sendXhr.status}catch(h){}e._posting=false;if(g==200){e._checkSend()}else{e._onDisconnect()}}};this._sendXhr.send("data="+encodeURIComponent(f))};b.prototype.disconnect=function(){this._onDisconnect();return this};b.prototype._onDisconnect=function(){if(this._xhr){this._xhr.onreadystatechange=d;try{this._xhr.abort()}catch(f){}this._xhr=null}if(this._sendXhr){this._sendXhr.onreadystatechange=d;try{this._sendXhr.abort()}catch(f){}this._sendXhr=null}this._sendBuffer=[];io.Transport.prototype._onDisconnect.call(this)};b.prototype._request=function(f,h,e){var g=c(this.base._isXDomain());if(e){g.multipart=true}g.open(h||"GET",this._prepareUrl()+(f?"/"+f:""));if(h=="POST"&&"setRequestHeader" in g){g.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=utf-8")}return g};b.check=function(f){try{if(c(f)){return true}}catch(g){}return false};b.xdomainCheck=function(){return b.check(true)};b.request=c})();(function(){var a=io.Transport.websocket=function(){io.Transport.apply(this,arguments)};io.util.inherit(a,io.Transport);a.prototype.type="websocket";a.prototype.connect=function(){var b=this;this.socket=new WebSocket(this._prepareUrl());this.socket.onmessage=function(c){b._onData(c.data)};this.socket.onclose=function(c){b._onClose()};this.socket.onerror=function(c){b._onError(c)};return this};a.prototype.send=function(b){if(this.socket){this.socket.send(this._encode(b))}return this};a.prototype.disconnect=function(){if(this.socket){this.socket.close()}return this};a.prototype._onClose=function(){this._onDisconnect();return this};a.prototype._onError=function(b){this.base.emit("error",[b])};a.prototype._prepareUrl=function(){return(this.base.options.secure?"wss":"ws")+"://"+this.base.host+":"+this.base.options.port+"/"+this.base.options.resource+"/"+this.type+(this.sessionid?("/"+this.sessionid):"")};a.check=function(){return"WebSocket" in window&&WebSocket.prototype&&(WebSocket.prototype.send&&!!WebSocket.prototype.send.toString().match(/native/i))&&typeof WebSocket!=="undefined"};a.xdomainCheck=function(){return true}})();(function(){var a=io.Transport.flashsocket=function(){io.Transport.websocket.apply(this,arguments)};io.util.inherit(a,io.Transport.websocket);a.prototype.type="flashsocket";a.prototype.connect=function(){var b=this,c=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.connect.apply(b,c)});return this};a.prototype.send=function(){var b=this,c=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.send.apply(b,c)});return this};a.check=function(){if(typeof WebSocket=="undefined"||!("__addTask" in WebSocket)){return false}if(io.util.opera){return false}if("navigator" in window&&"plugins" in navigator&&navigator.plugins["Shockwave Flash"]){return !!navigator.plugins["Shockwave Flash"].description}if("ActiveXObject" in window){try{return !!new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(b){}}return false};a.xdomainCheck=function(){return true}})();(function(){var a=io.Transport.htmlfile=function(){io.Transport.XHR.apply(this,arguments)};io.util.inherit(a,io.Transport.XHR);a.prototype.type="htmlfile";a.prototype._get=function(){var b=this;this._open();window.attachEvent("onunload",function(){b._destroy()})};a.prototype._open=function(){this._doc=new ActiveXObject("htmlfile");this._doc.open();this._doc.write("<html></html>");this._doc.parentWindow.s=this;this._doc.close();var b=this._doc.createElement("div");this._doc.body.appendChild(b);this._iframe=this._doc.createElement("iframe");b.appendChild(this._iframe);this._iframe.src=this._prepareUrl()+"/"+(+new Date)};a.prototype._=function(c,d){this._onData(c);var b=d.getElementsByTagName("script")[0];b.parentNode.removeChild(b)};a.prototype._destroy=function(){if(this._iframe){this._iframe.src="about:blank";this._doc=null;CollectGarbage()}};a.prototype.disconnect=function(){this._destroy();return io.Transport.XHR.prototype.disconnect.call(this)};a.check=function(){if("ActiveXObject" in window){try{var b=new ActiveXObject("htmlfile");return b&&io.Transport.XHR.check()}catch(c){}}return false};a.xdomainCheck=function(){return false}})();(function(){var a=io.Transport["xhr-multipart"]=function(){io.Transport.XHR.apply(this,arguments)};io.util.inherit(a,io.Transport.XHR);a.prototype.type="xhr-multipart";a.prototype._get=function(){var b=this;this._xhr=this._request("","GET",true);this._xhr.onreadystatechange=function(){if(b._xhr.readyState==4){b._onData(b._xhr.responseText)}};this._xhr.send(null)};a.check=function(){return"XMLHttpRequest" in window&&"prototype" in XMLHttpRequest&&"multipart" in XMLHttpRequest.prototype};a.xdomainCheck=function(){return true}})();(function(){var a=new Function(),b=io.Transport["xhr-polling"]=function(){io.Transport.XHR.apply(this,arguments)};io.util.inherit(b,io.Transport.XHR);b.prototype.type="xhr-polling";b.prototype.connect=function(){if(io.util.ios||io.util.android){var c=this;io.util.load(function(){setTimeout(function(){io.Transport.XHR.prototype.connect.call(c)},10)})}else{io.Transport.XHR.prototype.connect.call(this)}};b.prototype._get=function(){var c=this;this._xhr=this._request(+new Date,"GET");this._xhr.onreadystatechange=function(){var d;if(c._xhr.readyState==4){c._xhr.onreadystatechange=a;try{d=c._xhr.status}catch(f){}if(d==200){c._onData(c._xhr.responseText);c._get()}else{c._onDisconnect()}}};this._xhr.send(null)};b.check=function(){return io.Transport.XHR.check()};b.xdomainCheck=function(){return io.Transport.XHR.xdomainCheck()}})();io.JSONP=[];JSONPPolling=io.Transport["jsonp-polling"]=function(){io.Transport.XHR.apply(this,arguments);this._insertAt=document.getElementsByTagName("script")[0];this._index=io.JSONP.length;io.JSONP.push(this)};io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]);JSONPPolling.prototype.type="jsonp-polling";JSONPPolling.prototype._send=function(h){var k=this;if(!("_form" in this)){var b=document.createElement("FORM"),c=document.createElement("TEXTAREA"),a=this._iframeId="socket_io_iframe_"+this._index,g;b.style.position="absolute";b.style.top="-1000px";b.style.left="-1000px";b.target=a;b.method="POST";b.action=this._prepareUrl()+"/"+(+new Date)+"/"+this._index;c.name="data";b.appendChild(c);this._insertAt.parentNode.insertBefore(b,this._insertAt);document.body.appendChild(b);this._form=b;this._area=c}function d(){f();k._posting=false;k._checkSend()}function f(){if(k._iframe){k._form.removeChild(k._iframe)}try{g=document.createElement('<iframe name="'+k._iframeId+'">')}catch(l){g=document.createElement("iframe");g.name=k._iframeId}g.id=k._iframeId;k._form.appendChild(g);k._iframe=g}f();this._posting=true;this._area.value=h;try{this._form.submit()}catch(j){}if(this._iframe.attachEvent){g.onreadystatechange=function(){if(k._iframe.readyState=="complete"){d()}}}else{this._iframe.onload=d}};JSONPPolling.prototype._get=function(){var b=this,a=document.createElement("SCRIPT");if(this._script){this._script.parentNode.removeChild(this._script);this._script=null}a.async=true;a.src=this._prepareUrl()+"/"+(+new Date)+"/"+this._index;a.onerror=function(){b._onDisconnect()};this._insertAt.parentNode.insertBefore(a,this._insertAt);this._script=a};JSONPPolling.prototype._=function(){this._onData.apply(this,arguments);this._get();return this};JSONPPolling.check=function(){return true};JSONPPolling.xdomainCheck=function(){return true};(function(){var a=io.Socket=function(c,b){this.host=c||document.domain;this.options={secure:false,document:document,port:document.location.port||80,resource:"socket.io",transports:["websocket","flashsocket","htmlfile","xhr-multipart","xhr-polling","jsonp-polling"],transportOptions:{"xhr-polling":{timeout:25000},"jsonp-polling":{timeout:25000}},connectTimeout:5000,tryTransportsOnConnectTimeout:true,rememberTransport:true};io.util.merge(this.options,b);this.connected=false;this.connecting=false;this._events={};this.transport=this.getTransport();if(!this.transport&&"console" in window){console.error("No transport available")}};a.prototype.getTransport=function(e){var b=e||this.options.transports,c;if(this.options.rememberTransport&&!e){c=this.options.document.cookie.match("(?:^|;)\\s*socketio=([^;]*)");if(c){this._rememberedTransport=true;b=[decodeURIComponent(c[1])]}}for(var d=0,f;f=b[d];d++){if(io.Transport[f]&&io.Transport[f].check()&&(!this._isXDomain()||io.Transport[f].xdomainCheck())){return new io.Transport[f](this,this.options.transportOptions[f]||{})}}return null};a.prototype.connect=function(){if(this.transport&&!this.connected){if(this.connecting){this.disconnect()}this.connecting=true;this.emit("connecting",[this.transport.type]);this.transport.connect();if(this.options.connectTimeout){var b=this;this.connectTimeoutTimer=setTimeout(function(){if(!b.connected){b.disconnect();if(b.options.tryTransportsOnConnectTimeout&&!b._rememberedTransport){if(!b._remainingTransports){b._remainingTransports=b.options.transports.slice(0)}var c=b._remainingTransports;while(c.length>0&&c.splice(0,1)[0]!=b.transport.type){}if(c.length){b.transport=b.getTransport(c);b.connect()}}if(!b._remainingTransports||b._remainingTransports.length==0){b.emit("connect_failed")}}if(b._remainingTransports&&b._remainingTransports.length==0){delete b._remainingTransports}},this.options.connectTimeout)}}return this};a.prototype.send=function(b){if(!this.transport||!this.transport.connected){return this._queue(b)}this.transport.send(b);return this};a.prototype.disconnect=function(){if(this.connectTimeoutTimer){clearTimeout(this.connectTimeoutTimer)}this.transport.disconnect();return this};a.prototype.on=function(b,c){if(!(b in this._events)){this._events[b]=[]}this._events[b].push(c);return this};a.prototype.emit=function(c,b){if(c in this._events){var e=this._events[c].concat();for(var d=0,f=e.length;d<f;d++){e[d].apply(this,b===undefined?[]:b)}}return this};a.prototype.removeEvent=function(d,e){if(d in this._events){for(var c=0,b=this._events[d].length;c<b;c++){if(this._events[d][c]==e){this._events[d].splice(c,1)}}}return this};a.prototype._queue=function(b){if(!("_queueStack" in this)){this._queueStack=[]}this._queueStack.push(b);return this};a.prototype._doQueue=function(){if(!("_queueStack" in this)||!this._queueStack.length){return this}this.transport.send(this._queueStack);this._queueStack=[];return this};a.prototype._isXDomain=function(){return this.host!==document.domain};a.prototype._onConnect=function(){this.connected=true;this.connecting=false;this._doQueue();if(this.options.rememberTransport){this.options.document.cookie="socketio="+encodeURIComponent(this.transport.type)}this.emit("connect")};a.prototype._onMessage=function(b){this.emit("message",[b])};a.prototype._onDisconnect=function(){var b=this.connected;this.connected=false;this.connecting=false;this._queueStack=[];if(b){this.emit("disconnect")}};a.prototype.fire=a.prototype.emit;a.prototype.addListener=a.prototype.addEvent=a.prototype.addEventListener=a.prototype.on})();var swfobject=function(){var aq="undefined",aD="object",ab="Shockwave Flash",X="ShockwaveFlash.ShockwaveFlash",aE="application/x-shockwave-flash",ac="SWFObjectExprInst",ax="onreadystatechange",af=window,aL=document,aB=navigator,aa=false,Z=[aN],aG=[],ag=[],al=[],aJ,ad,ap,at,ak=false,aU=false,aH,an,aI=true,ah=function(){var a=typeof aL.getElementById!=aq&&typeof aL.getElementsByTagName!=aq&&typeof aL.createElement!=aq,e=aB.userAgent.toLowerCase(),c=aB.platform.toLowerCase(),h=c?/win/.test(c):/win/.test(e),k=c?/mac/.test(c):/mac/.test(e),g=/webkit/.test(e)?parseFloat(e.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,d=!+"\v1",f=[0,0,0],l=null;if(typeof aB.plugins!=aq&&typeof aB.plugins[ab]==aD){l=aB.plugins[ab].description;if(l&&!(typeof aB.mimeTypes!=aq&&aB.mimeTypes[aE]&&!aB.mimeTypes[aE].enabledPlugin)){aa=true;d=false;l=l.replace(/^.*\s+(\S+\s+\S+$)/,"$1");f[0]=parseInt(l.replace(/^(.*)\..*$/,"$1"),10);f[1]=parseInt(l.replace(/^.*\.(.*)\s.*$/,"$1"),10);f[2]=/[a-zA-Z]/.test(l)?parseInt(l.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof af.ActiveXObject!=aq){try{var j=new ActiveXObject(X);if(j){l=j.GetVariable("$version");if(l){d=true;l=l.split(" ")[1].split(",");f=[parseInt(l[0],10),parseInt(l[1],10),parseInt(l[2],10)]}}}catch(b){}}}return{w3:a,pv:f,wk:g,ie:d,win:h,mac:k}}(),aK=function(){if(!ah.w3){return}if((typeof aL.readyState!=aq&&aL.readyState=="complete")||(typeof aL.readyState==aq&&(aL.getElementsByTagName("body")[0]||aL.body))){aP()}if(!ak){if(typeof aL.addEventListener!=aq){aL.addEventListener("DOMContentLoaded",aP,false)}if(ah.ie&&ah.win){aL.attachEvent(ax,function(){if(aL.readyState=="complete"){aL.detachEvent(ax,arguments.callee);aP()}});if(af==top){(function(){if(ak){return}try{aL.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}aP()})()}}if(ah.wk){(function(){if(ak){return}if(!/loaded|complete/.test(aL.readyState)){setTimeout(arguments.callee,0);return}aP()})()}aC(aP)}}();function aP(){if(ak){return}try{var b=aL.getElementsByTagName("body")[0].appendChild(ar("span"));b.parentNode.removeChild(b)}catch(a){return}ak=true;var d=Z.length;for(var c=0;c<d;c++){Z[c]()}}function aj(a){if(ak){a()}else{Z[Z.length]=a}}function aC(a){if(typeof af.addEventListener!=aq){af.addEventListener("load",a,false)}else{if(typeof aL.addEventListener!=aq){aL.addEventListener("load",a,false)}else{if(typeof af.attachEvent!=aq){aM(af,"onload",a)}else{if(typeof af.onload=="function"){var b=af.onload;af.onload=function(){b();a()}}else{af.onload=a}}}}}function aN(){if(aa){Y()}else{am()}}function Y(){var d=aL.getElementsByTagName("body")[0];var b=ar(aD);b.setAttribute("type",aE);var a=d.appendChild(b);if(a){var c=0;(function(){if(typeof a.GetVariable!=aq){var e=a.GetVariable("$version");if(e){e=e.split(" ")[1].split(",");ah.pv=[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10)]}}else{if(c<10){c++;setTimeout(arguments.callee,10);return}}d.removeChild(b);a=null;am()})()}else{am()}}function am(){var g=aG.length;if(g>0){for(var h=0;h<g;h++){var c=aG[h].id;var m=aG[h].callbackFn;var a={success:false,id:c};if(ah.pv[0]>0){var j=aS(c);if(j){if(ao(aG[h].swfVersion)&&!(ah.wk&&ah.wk<312)){ay(c,true);if(m){a.success=true;a.ref=av(c);m(a)}}else{if(aG[h].expressInstall&&au()){var e={};e.data=aG[h].expressInstall;e.width=j.getAttribute("width")||"0";e.height=j.getAttribute("height")||"0";if(j.getAttribute("class")){e.styleclass=j.getAttribute("class")}if(j.getAttribute("align")){e.align=j.getAttribute("align")}var f={};var d=j.getElementsByTagName("param");var l=d.length;for(var k=0;k<l;k++){if(d[k].getAttribute("name").toLowerCase()!="movie"){f[d[k].getAttribute("name")]=d[k].getAttribute("value")}}ae(e,f,c,m)}else{aF(j);if(m){m(a)}}}}}else{ay(c,true);if(m){var b=av(c);if(b&&typeof b.SetVariable!=aq){a.success=true;a.ref=b}m(a)}}}}}function av(b){var d=null;var c=aS(b);if(c&&c.nodeName=="OBJECT"){if(typeof c.SetVariable!=aq){d=c}else{var a=c.getElementsByTagName(aD)[0];if(a){d=a}}}return d}function au(){return !aU&&ao("6.0.65")&&(ah.win||ah.mac)&&!(ah.wk&&ah.wk<312)}function ae(f,d,h,e){aU=true;ap=e||null;at={success:false,id:h};var a=aS(h);if(a){if(a.nodeName=="OBJECT"){aJ=aO(a);ad=null}else{aJ=a;ad=h}f.id=ac;if(typeof f.width==aq||(!/%$/.test(f.width)&&parseInt(f.width,10)<310)){f.width="310"}if(typeof f.height==aq||(!/%$/.test(f.height)&&parseInt(f.height,10)<137)){f.height="137"}aL.title=aL.title.slice(0,47)+" - Flash Player Installation";var b=ah.ie&&ah.win?"ActiveX":"PlugIn",c="MMredirectURL="+af.location.toString().replace(/&/g,"%26")+"&MMplayerType="+b+"&MMdoctitle="+aL.title;if(typeof d.flashvars!=aq){d.flashvars+="&"+c}else{d.flashvars=c}if(ah.ie&&ah.win&&a.readyState!=4){var g=ar("div");h+="SWFObjectNew";g.setAttribute("id",h);a.parentNode.insertBefore(g,a);a.style.display="none";(function(){if(a.readyState==4){a.parentNode.removeChild(a)}else{setTimeout(arguments.callee,10)}})()}aA(f,d,h)}}function aF(a){if(ah.ie&&ah.win&&a.readyState!=4){var b=ar("div");a.parentNode.insertBefore(b,a);b.parentNode.replaceChild(aO(a),b);a.style.display="none";(function(){if(a.readyState==4){a.parentNode.removeChild(a)}else{setTimeout(arguments.callee,10)}})()}else{a.parentNode.replaceChild(aO(a),a)}}function aO(b){var d=ar("div");if(ah.win&&ah.ie){d.innerHTML=b.innerHTML}else{var e=b.getElementsByTagName(aD)[0];if(e){var a=e.childNodes;if(a){var f=a.length;for(var c=0;c<f;c++){if(!(a[c].nodeType==1&&a[c].nodeName=="PARAM")&&!(a[c].nodeType==8)){d.appendChild(a[c].cloneNode(true))}}}}}return d}function aA(e,g,c){var d,a=aS(c);if(ah.wk&&ah.wk<312){return d}if(a){if(typeof e.id==aq){e.id=c}if(ah.ie&&ah.win){var f="";for(var j in e){if(e[j]!=Object.prototype[j]){if(j.toLowerCase()=="data"){g.movie=e[j]}else{if(j.toLowerCase()=="styleclass"){f+=' class="'+e[j]+'"'}else{if(j.toLowerCase()!="classid"){f+=" "+j+'="'+e[j]+'"'}}}}}var h="";for(var k in g){if(g[k]!=Object.prototype[k]){h+='<param name="'+k+'" value="'+g[k]+'" />'}}a.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+f+">"+h+"</object>";ag[ag.length]=e.id;d=aS(e.id)}else{var b=ar(aD);b.setAttribute("type",aE);for(var l in e){if(e[l]!=Object.prototype[l]){if(l.toLowerCase()=="styleclass"){b.setAttribute("class",e[l])}else{if(l.toLowerCase()!="classid"){b.setAttribute(l,e[l])}}}}for(var m in g){if(g[m]!=Object.prototype[m]&&m.toLowerCase()!="movie"){aQ(b,m,g[m])}}a.parentNode.replaceChild(b,a);d=b}}return d}function aQ(b,d,c){var a=ar("param");a.setAttribute("name",d);a.setAttribute("value",c);b.appendChild(a)}function aw(a){var b=aS(a);if(b&&b.nodeName=="OBJECT"){if(ah.ie&&ah.win){b.style.display="none";(function(){if(b.readyState==4){aT(a)}else{setTimeout(arguments.callee,10)}})()}else{b.parentNode.removeChild(b)}}}function aT(a){var b=aS(a);if(b){for(var c in b){if(typeof b[c]=="function"){b[c]=null}}b.parentNode.removeChild(b)}}function aS(a){var c=null;try{c=aL.getElementById(a)}catch(b){}return c}function ar(a){return aL.createElement(a)}function aM(a,c,b){a.attachEvent(c,b);al[al.length]=[a,c,b]}function ao(a){var b=ah.pv,c=a.split(".");c[0]=parseInt(c[0],10);c[1]=parseInt(c[1],10)||0;c[2]=parseInt(c[2],10)||0;return(b[0]>c[0]||(b[0]==c[0]&&b[1]>c[1])||(b[0]==c[0]&&b[1]==c[1]&&b[2]>=c[2]))?true:false}function az(b,f,a,c){if(ah.ie&&ah.mac){return}var e=aL.getElementsByTagName("head")[0];if(!e){return}var g=(a&&typeof a=="string")?a:"screen";if(c){aH=null;an=null}if(!aH||an!=g){var d=ar("style");d.setAttribute("type","text/css");d.setAttribute("media",g);aH=e.appendChild(d);if(ah.ie&&ah.win&&typeof aL.styleSheets!=aq&&aL.styleSheets.length>0){aH=aL.styleSheets[aL.styleSheets.length-1]}an=g}if(ah.ie&&ah.win){if(aH&&typeof aH.addRule==aD){aH.addRule(b,f)}}else{if(aH&&typeof aL.createTextNode!=aq){aH.appendChild(aL.createTextNode(b+" {"+f+"}"))}}}function ay(a,c){if(!aI){return}var b=c?"visible":"hidden";if(ak&&aS(a)){aS(a).style.visibility=b}else{az("#"+a,"visibility:"+b)}}function ai(b){var a=/[\\\"<>\.;]/;var c=a.exec(b)!=null;return c&&typeof encodeURIComponent!=aq?encodeURIComponent(b):b}var aR=function(){if(ah.ie&&ah.win){window.attachEvent("onunload",function(){var a=al.length;for(var b=0;b<a;b++){al[b][0].detachEvent(al[b][1],al[b][2])}var d=ag.length;for(var c=0;c<d;c++){aw(ag[c])}for(var e in ah){ah[e]=null}ah=null;for(var f in swfobject){swfobject[f]=null}swfobject=null})}}();return{registerObject:function(a,e,c,b){if(ah.w3&&a&&e){var d={};d.id=a;d.swfVersion=e;d.expressInstall=c;d.callbackFn=b;aG[aG.length]=d;ay(a,false)}else{if(b){b({success:false,id:a})}}},getObjectById:function(a){if(ah.w3){return av(a)}},embedSWF:function(l,e,h,f,c,a,b,j,g,k){var d={success:false,id:e};if(ah.w3&&!(ah.wk&&ah.wk<312)&&l&&e&&h&&f&&c){ay(e,false);aj(function(){h+="";f+="";var s={};if(g&&typeof g===aD){for(var p in g){s[p]=g[p]}}s.data=l;s.width=h;s.height=f;var o={};if(j&&typeof j===aD){for(var q in j){o[q]=j[q]}}if(b&&typeof b===aD){for(var m in b){if(typeof o.flashvars!=aq){o.flashvars+="&"+m+"="+b[m]}else{o.flashvars=m+"="+b[m]}}}if(ao(c)){var n=aA(s,o,e);if(s.id==e){ay(e,true)}d.success=true;d.ref=n}else{if(a&&au()){s.data=a;ae(s,o,e,k);return}else{ay(e,true)}}if(k){k(d)}})}else{if(k){k(d)}}},switchOffAutoHideShow:function(){aI=false},ua:ah,getFlashPlayerVersion:function(){return{major:ah.pv[0],minor:ah.pv[1],release:ah.pv[2]}},hasFlashPlayerVersion:ao,createSWF:function(a,b,c){if(ah.w3){return aA(a,b,c)}else{return undefined}},showExpressInstall:function(b,a,d,c){if(ah.w3&&au()){ae(b,a,d,c)}},removeSWF:function(a){if(ah.w3){aw(a)}},createCSS:function(b,a,c,d){if(ah.w3){az(b,a,c,d)}},addDomLoadEvent:aj,addLoadEvent:aC,getQueryParamValue:function(b){var a=aL.location.search||aL.location.hash;if(a){if(/\?/.test(a)){a=a.split("?")[1]}if(b==null){return ai(a)}var c=a.split("&");for(var d=0;d<c.length;d++){if(c[d].substring(0,c[d].indexOf("="))==b){return ai(c[d].substring((c[d].indexOf("=")+1)))}}}return""},expressInstallCallback:function(){if(aU){var a=aS(ac);if(a&&aJ){a.parentNode.replaceChild(aJ,a);if(ad){ay(ad,true);if(ah.ie&&ah.win){aJ.style.display="block"}}if(ap){ap(at)}}aU=false}}}}();function FABridge(b,a){this.target=b;this.remoteTypeCache={};this.remoteInstanceCache={};this.remoteFunctionCache={};this.localFunctionCache={};this.bridgeID=FABridge.nextBridgeID++;this.name=a;this.nextLocalFuncID=0;FABridge.instances[this.name]=this;FABridge.idMap[this.bridgeID]=this;return this}FABridge.TYPE_ASINSTANCE=1;FABridge.TYPE_ASFUNCTION=2;FABridge.TYPE_JSFUNCTION=3;FABridge.TYPE_ANONYMOUS=4;FABridge.initCallbacks={};FABridge.userTypes={};FABridge.addToUserTypes=function(){for(var a=0;a<arguments.length;a++){FABridge.userTypes[arguments[a]]={typeName:arguments[a],enriched:false}}};FABridge.argsToArray=function(b){var a=[];for(var c=0;c<b.length;c++){a[c]=b[c]}return a};function instanceFactory(a){this.fb_instance_id=a;return this}function FABridge__invokeJSFunction(a){var c=a[0];var b=a.concat();b.shift();var d=FABridge.extractBridgeFromID(c);return d.invokeLocalFunction(c,b)}FABridge.addInitializationCallback=function(b,d){var c=FABridge.instances[b];if(c!=undefined){d.call(c);return}var a=FABridge.initCallbacks[b];if(a==null){FABridge.initCallbacks[b]=a=[]}a.push(d)};function FABridge__bridgeInitialized(g){var a=document.getElementsByTagName("object");var f=a.length;var d=[];if(f>0){for(var v=0;v<f;v++){if(typeof a[v].SetVariable!="undefined"){d[d.length]=a[v]}}}var n=document.getElementsByTagName("embed");var b=n.length;var u=[];if(b>0){for(var s=0;s<b;s++){if(typeof n[s].SetVariable!="undefined"){u[u.length]=n[s]}}}var c=d.length;var t=u.length;var h="bridgeName="+g;if((c==1&&!t)||(c==1&&t==1)){FABridge.attachBridge(d[0],g)}else{if(t==1&&!c){FABridge.attachBridge(u[0],g)}else{var w=false;if(c>1){for(var q=0;q<c;q++){var y=d[q].childNodes;for(var p=0;p<y.length;p++){var e=y[p];if(e.nodeType==1&&e.tagName.toLowerCase()=="param"&&e.name.toLowerCase()=="flashvars"&&e.value.indexOf(h)>=0){FABridge.attachBridge(d[q],g);w=true;break}}if(w){break}}}if(!w&&t>1){for(var o=0;o<t;o++){var x=u[o].attributes.getNamedItem("flashVars").nodeValue;if(x.indexOf(h)>=0){FABridge.attachBridge(u[o],g);break}}}}}return true}FABridge.nextBridgeID=0;FABridge.instances={};FABridge.idMap={};FABridge.refCount=0;FABridge.extractBridgeFromID=function(b){var a=(b>>16);return FABridge.idMap[a]};FABridge.attachBridge=function(a,c){var b=new FABridge(a,c);FABridge[c]=b;var e=FABridge.initCallbacks[c];if(e==null){return}for(var d=0;d<e.length;d++){e[d].call(b)}delete FABridge.initCallbacks[c]};FABridge.blockedMethods={toString:true,get:true,set:true,call:true};FABridge.prototype={root:function(){return this.deserialize(this.target.getRoot())},releaseASObjects:function(){return this.target.releaseASObjects()},releaseNamedASObject:function(b){if(typeof(b)!="object"){return false}else{var a=this.target.releaseNamedASObject(b.fb_instance_id);return a}},create:function(a){return this.deserialize(this.target.create(a))},makeID:function(a){return(this.bridgeID<<16)+a},getPropertyFromAS:function(b,a){if(FABridge.refCount>0){throw new Error("You are trying to call recursively into the Flash Player which is not allowed. In most cases the JavaScript setTimeout function, can be used as a workaround.")}else{FABridge.refCount++;retVal=this.target.getPropFromAS(b,a);retVal=this.handleError(retVal);FABridge.refCount--;return retVal}},setPropertyInAS:function(c,b,a){if(FABridge.refCount>0){throw new Error("You are trying to call recursively into the Flash Player which is not allowed. In most cases the JavaScript setTimeout function, can be used as a workaround.")}else{FABridge.refCount++;retVal=this.target.setPropInAS(c,b,this.serialize(a));retVal=this.handleError(retVal);FABridge.refCount--;return retVal}},callASFunction:function(b,a){if(FABridge.refCount>0){throw new Error("You are trying to call recursively into the Flash Player which is not allowed. In most cases the JavaScript setTimeout function, can be used as a workaround.")}else{FABridge.refCount++;retVal=this.target.invokeASFunction(b,this.serialize(a));retVal=this.handleError(retVal);FABridge.refCount--;return retVal}},callASMethod:function(b,c,a){if(FABridge.refCount>0){throw new Error("You are trying to call recursively into the Flash Player which is not allowed. In most cases the JavaScript setTimeout function, can be used as a workaround.")}else{FABridge.refCount++;a=this.serialize(a);retVal=this.target.invokeASMethod(b,c,a);retVal=this.handleError(retVal);FABridge.refCount--;return retVal}},invokeLocalFunction:function(d,b){var a;var c=this.localFunctionCache[d];if(c!=undefined){a=this.serialize(c.apply(null,this.deserialize(b)))}return a},getTypeFromName:function(a){return this.remoteTypeCache[a]},createProxy:function(c,b){var d=this.getTypeFromName(b);instanceFactory.prototype=d;var a=new instanceFactory(c);this.remoteInstanceCache[c]=a;return a},getProxy:function(a){return this.remoteInstanceCache[a]},addTypeDataToCache:function(e){var c=new ASProxy(this,e.name);var b=e.accessors;for(var d=0;d<b.length;d++){this.addPropertyToType(c,b[d])}var a=e.methods;for(var d=0;d<a.length;d++){if(FABridge.blockedMethods[a[d]]==undefined){this.addMethodToType(c,a[d])}}this.remoteTypeCache[c.typeName]=c;return c},addPropertyToType:function(a,e){var f=e.charAt(0);var b;var d;if(f>="a"&&f<="z"){d="get"+f.toUpperCase()+e.substr(1);b="set"+f.toUpperCase()+e.substr(1)}else{d="get"+e;b="set"+e}a[b]=function(c){this.bridge.setPropertyInAS(this.fb_instance_id,e,c)};a[d]=function(){return this.bridge.deserialize(this.bridge.getPropertyFromAS(this.fb_instance_id,e))}},addMethodToType:function(a,b){a[b]=function(){return this.bridge.deserialize(this.bridge.callASMethod(this.fb_instance_id,b,FABridge.argsToArray(arguments)))}},getFunctionProxy:function(a){var b=this;if(this.remoteFunctionCache[a]==null){this.remoteFunctionCache[a]=function(){b.callASFunction(a,FABridge.argsToArray(arguments))}}return this.remoteFunctionCache[a]},getFunctionID:function(a){if(a.__bridge_id__==undefined){a.__bridge_id__=this.makeID(this.nextLocalFuncID++);this.localFunctionCache[a.__bridge_id__]=a}return a.__bridge_id__},serialize:function(d){var a={};var c=typeof(d);if(c=="number"||c=="string"||c=="boolean"||c==null||c==undefined){a=d}else{if(d instanceof Array){a=[];for(var b=0;b<d.length;b++){a[b]=this.serialize(d[b])}}else{if(c=="function"){a.type=FABridge.TYPE_JSFUNCTION;a.value=this.getFunctionID(d)}else{if(d instanceof ASProxy){a.type=FABridge.TYPE_ASINSTANCE;a.value=d.fb_instance_id}else{a.type=FABridge.TYPE_ANONYMOUS;a.value=d}}}}return a},deserialize:function(e){var a;var c=typeof(e);if(c=="number"||c=="string"||c=="boolean"||e==null||e==undefined){a=this.handleError(e)}else{if(e instanceof Array){a=[];for(var b=0;b<e.length;b++){a[b]=this.deserialize(e[b])}}else{if(c=="object"){for(var b=0;b<e.newTypes.length;b++){this.addTypeDataToCache(e.newTypes[b])}for(var d in e.newRefs){this.createProxy(d,e.newRefs[d])}if(e.type==FABridge.TYPE_PRIMITIVE){a=e.value}else{if(e.type==FABridge.TYPE_ASFUNCTION){a=this.getFunctionProxy(e.value)}else{if(e.type==FABridge.TYPE_ASINSTANCE){a=this.getProxy(e.value)}else{if(e.type==FABridge.TYPE_ANONYMOUS){a=e.value}}}}}}}return a},addRef:function(a){this.target.incRef(a.fb_instance_id)},release:function(a){this.target.releaseRef(a.fb_instance_id)},handleError:function(b){if(typeof(b)=="string"&&b.indexOf("__FLASHERROR")==0){var a=b.split("||");if(FABridge.refCount>0){FABridge.refCount--}throw new Error(a[1]);return b}else{return b}}};ASProxy=function(b,a){this.bridge=b;this.typeName=a;return this};ASProxy.prototype={get:function(a){return this.bridge.deserialize(this.bridge.getPropertyFromAS(this.fb_instance_id,a))},set:function(b,a){this.bridge.setPropertyInAS(this.fb_instance_id,b,a)},call:function(b,a){this.bridge.callASMethod(this.fb_instance_id,b,a)},addRef:function(){this.bridge.addRef(this)},release:function(){this.bridge.release(this)}};(function(){if(window.WebSocket){return}var a=window.console;if(!a||!a.log||!a.error){a={log:function(){},error:function(){}}}if(!swfobject.hasFlashPlayerVersion("9.0.0")){a.error("Flash Player is not installed.");return}if(location.protocol=="file:"){a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://...")}WebSocket=function(e,h,d,g,f){var c=this;c.readyState=WebSocket.CONNECTING;c.bufferedAmount=0;setTimeout(function(){WebSocket.__addTask(function(){c.__createFlash(e,h,d,g,f)})},0)};WebSocket.prototype.__createFlash=function(e,h,d,g,f){var c=this;c.__flash=WebSocket.__flash.create(e,h,d||null,g||0,f||null);c.__flash.addEventListener("event",function(j){setTimeout(function(){c.__handleEvents()},0)})};WebSocket.prototype.send=function(d){if(!this.__flash||this.readyState==WebSocket.CONNECTING){throw"INVALID_STATE_ERR: Web Socket connection has not been established"}var c=this.__flash.send(encodeURIComponent(d));if(c<0){return true}else{this.bufferedAmount+=c;return false}};WebSocket.prototype.close=function(){var c=this;if(!c.__flash){return}if(c.readyState==WebSocket.CLOSED||c.readyState==WebSocket.CLOSING){return}c.__flash.close();c.readyState=WebSocket.CLOSED;if(c.__timer){clearInterval(c.__timer)}if(c.onclose){setTimeout(c.onclose,0)}};WebSocket.prototype.addEventListener=function(d,e,c){if(!("__events" in this)){this.__events={}}if(!(d in this.__events)){this.__events[d]=[];if("function"==typeof this["on"+d]){this.__events[d].defaultHandler=this["on"+d];this["on"+d]=this.__createEventHandler(this,d)}}this.__events[d].push(e)};WebSocket.prototype.removeEventListener=function(e,f,c){if(!("__events" in this)){this.__events={}}if(!(e in this.__events)){return}for(var d=this.__events.length;d>-1;--d){if(f===this.__events[e][d]){this.__events[e].splice(d,1);break}}};WebSocket.prototype.dispatchEvent=function(e){if(!("__events" in this)){throw"UNSPECIFIED_EVENT_TYPE_ERR"}if(!(e.type in this.__events)){throw"UNSPECIFIED_EVENT_TYPE_ERR"}for(var d=0,c=this.__events[e.type].length;d<c;++d){this.__events[e.type][d](e);if(e.cancelBubble){break}}if(false!==e.returnValue&&"function"==typeof this.__events[e.type].defaultHandler){this.__events[e.type].defaultHandler(e)}};WebSocket.prototype.__handleEvents=function(){var d=this.__flash.receiveEvents();for(var c=0;c<d.length;c++){try{var f=d[c];if("readyState" in f){this.readyState=f.readyState}if(f.type=="open"){if(this.__timer){clearInterval(this.__timer)}if(window.opera){this.__timer=setInterval(function(){this.__handleEvents()},500)}if(this.onopen){this.onopen()}}else{if(f.type=="close"){if(this.__timer){clearInterval(this.__timer)}if(this.onclose){this.onclose()}}else{if(f.type=="message"){if(this.onmessage){var g=decodeURIComponent(f.data);var h;if(window.MessageEvent&&!window.opera){h=document.createEvent("MessageEvent");h.initMessageEvent("message",false,false,g,null,null,window,null)}else{h={data:g}}this.onmessage(h)}}else{if(f.type=="error"){if(this.__timer){clearInterval(this.__timer)}if(this.onerror){this.onerror()}}else{throw"unknown event type: "+f.type}}}}}catch(h){a.error(h.toString())}}};WebSocket.prototype.__createEventHandler=function(c,d){return function(g){var f=new b();f.initEvent(d,true,true);f.target=f.currentTarget=c;for(var e in g){f[e]=g[e]}c.dispatchEvent(f,arguments)}};function b(){}b.prototype.cancelable=true;b.prototype.cancelBubble=false;b.prototype.preventDefault=function(){if(this.cancelable){this.returnValue=false}};b.prototype.stopPropagation=function(){this.cancelBubble=true};b.prototype.initEvent=function(c,e,d){this.type=c;this.cancelable=d;this.timeStamp=new Date()};WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;WebSocket.__tasks=[];WebSocket.loadFlashPolicyFile=function(c){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(c)})};WebSocket.__initialize=function(){if(WebSocket.__swfLocation){window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation}if(!window.WEB_SOCKET_SWF_LOCATION){a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var c=document.createElement("div");c.id="webSocketContainer";c.style.position="absolute";if(WebSocket.__isFlashLite()){c.style.left="0px";c.style.top="0px"}else{c.style.left="-100px";c.style.top="-100px"}var d=document.createElement("div");d.id="webSocketFlash";c.appendChild(d);document.body.appendChild(c);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","9.0.0",null,{bridgeName:"webSocket"},{hasPriority:true,allowScriptAccess:"always"},null,function(f){if(!f.success){a.error("[WebSocket] swfobject.embedSWF failed")}});FABridge.addInitializationCallback("webSocket",function(){try{WebSocket.__flash=FABridge.webSocket.root();WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var f=0;f<WebSocket.__tasks.length;++f){WebSocket.__tasks[f]()}WebSocket.__tasks=[]}catch(g){a.error("[WebSocket] "+g.toString())}})};WebSocket.__addTask=function(c){if(WebSocket.__flash){c()}else{WebSocket.__tasks.push(c)}};WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes){return false}var c=window.navigator.mimeTypes["application/x-shockwave-flash"];if(!c||!c.enabledPlugin||!c.enabledPlugin.filename){return false}return c.enabledPlugin.filename.match(/flashlite/i)?true:false};window.webSocketLog=function(c){a.log(decodeURIComponent(c))};window.webSocketError=function(c){a.error(decodeURIComponent(c))};if(!window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION){if(window.addEventListener){window.addEventListener("load",WebSocket.__initialize,false)}else{window.attachEvent("onload",WebSocket.__initialize)}}})();$(function(){window.register_sockets=function(){window.active_doc.socket_subscriber=new io.Socket(window.location.hostname,{port:443,secure:true,rememberTransport:false,transports:["xhr-polling","jsonp-polling"]});window.active_doc.socket_subscriber.connect();window.active_doc.socket_subscriber.render_queue={};window.active_doc.socket_subscriber.on("message",function(d){var c=window.active_doc.socket_subscriber;var d=JSON.parse(d);if(d.type=="registration_confirmation"){window.active_doc.socket_subscriber.id=d.clientid}else{_.each(d.outline,function(e){var f=window.collections.get(e.id,"outline");if(f){f.update(e)}else{f=new outline.Outline();f.update(e);window.collections.set_mem(f.get("id"),f,"outline")}c.render_queue[f.get("id")]=f});var b,a;b=_.filter(_.keys(c.render_queue),function(e){var j=window.collections.get(e,"outline");var h=j.get("parent");var g=j.get("children");var k=!h||window.collections.get(h,"outline");var f=!g||_.all(g,function(l){return window.collections.get(l,"outline")});return k&&f});a=_.filter(_.keys(c.render_queue),function(e){var j=window.collections.get(e,"outline");var h=j.get("parent");var g=j.get("children");var k=!h||window.collections.get(h,"outline");var f=!g||_.all(g,function(l){return window.collections.get(l,"outline")});return !(k&&f)});_.each(b,function(e){window.collections.get(e,"outline").render()});c.render_queue={};_.each(a,function(e){c.render_queue[e]=window.collections.get(e,"outline")})}});window.active_doc.socket_subscriber.on("connect",function(){console.log("connected sockets");window.active_doc.socket_subscriber.send(JSON.stringify({type:"registration",docid:window.active_doc.id}));$("#connected").html("CONNECTED: edits from others will appear instantly!")});window.active_doc.socket_subscriber.on("disconnect",function(){console.log("disconnected sockets");$("#connected").html("disconnected")})}});